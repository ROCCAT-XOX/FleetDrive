{{ define "vehicle/details.html" }}
{{ template "head" .}}
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen flex flex-col">
<!-- Navigation -->
{{ template "navigation" .}}

<!-- Main Content -->
<main class="container mx-auto px-4 py-6 flex-grow">
    <!-- Zurück-Button und Titel -->
    <div class="mb-6 flex items-center justify-between">
        <div class="flex items-center">
            <a href="/vehicles" class="inline-flex items-center mr-4 text-sm font-medium text-indigo-600 hover:text-indigo-500">
                <svg class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Zurück zur Übersicht
            </a>
            <h1 class="text-2xl font-bold text-gray-900" id="vehicle-title">Fahrzeugdetails</h1>
        </div>
        <div>
        <span id="vehicle-status" class="px-2.5 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
          Wird geladen...
        </span>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="mb-6 border-b border-gray-200">
        <nav class="flex flex-wrap space-x-8" aria-label="Tabs">
            <button type="button" class="vehicle-tab-btn border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="basic-info">
                Fahrzeuginformationen
            </button>
            <button type="button" class="vehicle-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="current-usage">
                Aktuelle Nutzung
            </button>
            <button type="button" class="vehicle-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="registration-insurance">
                Zulassung & Versicherung
            </button>
            <button type="button" class="vehicle-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="maintenance">
                Wartung & Inspektion
            </button>
            <button type="button" class="vehicle-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="usage-history">
                Nutzungshistorie
            </button>
            <button type="button" class="vehicle-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="statistics">
                Statistiken
            </button>
        </nav>
    </div>

    <!-- Tab Contents -->
    <div id="vehicle-tab-contents">
        {{ template "vehicle/basic_info" . }}
        {{ template "vehicle/current_usage" . }}
        {{ template "vehicle/registration" . }}
        {{ template "vehicle/maintenance" . }}
        {{ template "vehicle/usage_history" . }}
        {{ template "vehicle/statistics" . }}
    </div>
</main>

<!-- Footer -->
{{ template "footer" .}}

<!-- Modals -->
{{ template "vehicle/modals" . }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
    // Der existierende JavaScript-Code für die Fahrzeugdetails
    // vehicle-details.js - Zuständig für die Funktionalität der Fahrzeugdetail-Seite

    document.addEventListener('DOMContentLoaded', function() {
        // Tab-Funktionalität
        const tabButtons = document.querySelectorAll('.vehicle-tab-btn');
        const tabContents = document.querySelectorAll('.vehicle-tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.getAttribute('data-tab');

                // Alle Tabs ausblenden
                tabContents.forEach(content => {
                    content.classList.add('hidden');
                });

                // Alle Tab-Buttons zurücksetzen
                tabButtons.forEach(btn => {
                    btn.classList.remove('border-blue-500', 'text-blue-600');
                    btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                });

                // Ausgewählten Tab anzeigen
                document.getElementById(tabName).classList.remove('hidden');

                // Aktuellen Button hervorheben
                button.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                button.classList.add('border-blue-500', 'text-blue-600');
            });
        });

        // Parameter aus der URL extrahieren
        const vehicleId = window.location.pathname.split('/').pop();

        // Fahrzeugdaten laden
        loadVehicleData();

        // Event-Listener für die Wartungsmodals
        setupMaintenanceModals();

        // Event-Listener für die Nutzungsmodals
        setupUsageModals();

        // Event-Listener für das Fahrzeug-Bearbeiten-Modal
        setupVehicleEditModal();

        // Funktion zum Laden der Fahrzeugdaten
        function loadVehicleData() {
            fetch(`/api/vehicles/${vehicleId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Fahrzeug nicht gefunden');
                    return response.json();
                })
                .then(data => {
                    const vehicle = data.vehicle;
                    console.log("Geladene Fahrzeugdaten:", vehicle);

                    // Seitentitel und Status aktualisieren
                    updateHeaderInfo(vehicle);

                    // UI mit Fahrzeugdaten aktualisieren
                    updateVehicleDisplay(vehicle);

                    // Wenn ein Fahrer zugewiesen ist, Fahrerdaten laden
                    if (vehicle.currentDriverId &&
                        vehicle.currentDriverId !== '000000000000000000000000') {
                        loadCurrentDriverData(vehicle.currentDriverId);
                    } else {
                        updateCurrentUsageDisplay(null);
                    }

                    // Wartungseinträge laden
                    loadMaintenanceEntries();

                    // Nutzungshistorie laden
                    loadUsageHistory();

                    // Wenn ApexCharts verfügbar ist, Charts erstellen
                    if (typeof ApexCharts !== 'undefined') {
                        createCharts();
                    }
                })
                .catch(error => {
                    console.error('Fehler beim Laden der Fahrzeugdaten:', error);
                    showNotification('Fehler beim Laden der Fahrzeugdaten', 'error');
                });
        }

        // Funktion zum Aktualisieren des Headers (Titel und Status)
        function updateHeaderInfo(vehicle) {
            const vehicleTitle = document.getElementById('vehicle-title');
            const vehicleStatus = document.getElementById('vehicle-status');

            if (vehicleTitle) {
                vehicleTitle.textContent = `${vehicle.brand} ${vehicle.model} (${vehicle.licensePlate})`;
            }

            if (vehicleStatus) {
                let statusClass, statusText;

                switch(vehicle.status) {
                    case 'available':
                        statusClass = 'bg-green-100 text-green-800';
                        statusText = 'Verfügbar';
                        break;
                    case 'inuse':
                        statusClass = 'bg-red-100 text-red-800';
                        statusText = 'In Benutzung';
                        break;
                    case 'maintenance':
                        statusClass = 'bg-yellow-100 text-yellow-800';
                        statusText = 'In Wartung';
                        break;
                    default:
                        statusClass = 'bg-gray-100 text-gray-800';
                        statusText = vehicle.status || 'Unbekannt';
                }

                vehicleStatus.className = `px-2.5 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}`;
                vehicleStatus.textContent = statusText;
            }
        }

        // Funktion zum Aktualisieren der Fahrzeugdetails im UI
        function updateVehicleDisplay(vehicle) {
            // Grundlegende Informationen
            setElementText('license-plate-display', vehicle.licensePlate);
            setElementText('brand-model-display', vehicle.brand + ' ' + vehicle.model);
            setElementText('year-display', vehicle.year);
            setElementText('color-display', vehicle.color);
            setElementText('vehicle-id-display', vehicle.vehicleId);
            setElementText('vin-display', vehicle.vin);
            setElementText('fuel-type-display', vehicle.fuelType);
            setElementText('mileage-display', `${vehicle.mileage} km`);

            // Zulassung und Versicherung
            setElementText('registration-date-display', formatDate(vehicle.registrationDate));
            setElementText('next-inspection-display', formatDate(vehicle.nextInspectionDate));
            setElementText('insurance-company-display', vehicle.insuranceCompany);
            setElementText('insurance-number-display', vehicle.insuranceNumber);
            setElementText('insurance-type-display', vehicle.insuranceType);

            // Auch Formulare mit Werten vorausfüllen (für Modals)
            if (document.getElementById('edit-vehicle-form')) {
                document.getElementById('license_plate').value = vehicle.licensePlate || '';
                document.getElementById('model').value = (vehicle.brand + ' ' + vehicle.model) || '';
                document.getElementById('year').value = vehicle.year || '';
                document.getElementById('color').value = vehicle.color || '';
                document.getElementById('vehicle_id').value = vehicle.vehicleId || '';
                document.getElementById('vin').value = vehicle.vin || '';
                document.getElementById('fuel_type').value = vehicle.fuelType || '';
                document.getElementById('current_mileage').value = vehicle.mileage || 0;

                if (vehicle.registrationDate) {
                    document.getElementById('registration_date').value = formatDateForInput(vehicle.registrationDate);
                }

                if (vehicle.nextInspectionDate) {
                    document.getElementById('next_inspection').value = formatDateForInput(vehicle.nextInspectionDate);
                }

                document.getElementById('insurance').value = vehicle.insuranceCompany || '';
                document.getElementById('insurance_number').value = vehicle.insuranceNumber || '';
                document.getElementById('insurance_type').value = vehicle.insuranceType || '';
                document.getElementById('vehicle_notes').value = vehicle.notes || '';
            }
        }

        // Funktion zum Laden und Anzeigen der Daten des aktuellen Fahrers
        function loadCurrentDriverData(driverId) {
            fetch(`/api/drivers/${driverId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Fahrer nicht gefunden');
                    return response.json();
                })
                .then(data => {
                    const driver = data.driver;
                    console.log("Geladene Fahrerdaten:", driver);

                    // Aktive Nutzung abfragen
                    return fetch(`/api/usage/vehicle/${vehicleId}`)
                        .then(response => {
                            if (!response.ok) throw new Error('Nutzungsdaten nicht gefunden');
                            return response.json();
                        })
                        .then(usageData => {
                            // Aktive Nutzung herausfiltern
                            const activeUsage = usageData.usage.find(entry => entry.status === 'active');

                            updateCurrentUsageDisplay(driver, activeUsage);
                            return { driver, activeUsage };
                        });
                })
                .catch(error => {
                    console.error('Fehler beim Laden der Fahrerdaten:', error);
                    updateCurrentUsageDisplay(null);
                });
        }

        // Funktion zum Aktualisieren der Anzeige der aktuellen Nutzung
        function updateCurrentUsageDisplay(driver, activeUsage = null) {
            const currentUsageTab = document.getElementById('current-usage');

            if (!currentUsageTab) return;

            if (!driver) {
                // Kein Fahrer zugewiesen
                currentUsageTab.innerHTML = `
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="px-4 py-5 sm:px-6 bg-gray-50 border-b border-gray-200">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Aktuelle Nutzung</h3>
                    </div>
                    <div class="px-4 py-5 sm:p-6 text-center text-gray-500">
                        <p>Dieses Fahrzeug wird derzeit nicht genutzt.</p>
                        <button id="start-usage-btn" type="button" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <svg class="-ml-1 mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            Nutzung starten
                        </button>
                    </div>
                </div>
            `;

                // Event-Listener für den "Nutzung starten"-Button
                const startUsageBtn = document.getElementById('start-usage-btn');
                if (startUsageBtn) {
                    startUsageBtn.addEventListener('click', () => {
                        const usageModal = document.getElementById('usage-modal');
                        if (usageModal) {
                            usageModal.classList.remove('hidden');
                        }
                    });
                }

                return;
            }

            // Fahrer ist zugewiesen, zeige Details an
            let usageStartDate = "Unbekannt";
            let usageEndDate = "Nicht festgelegt";
            let department = "";
            let project = "";

            if (activeUsage) {
                usageStartDate = formatDateTime(activeUsage.startDate);

                if (activeUsage.endDate) {
                    usageEndDate = formatDateTime(activeUsage.endDate);
                }

                department = activeUsage.department || "";
                project = activeUsage.project || activeUsage.purpose || "";
            }

            currentUsageTab.innerHTML = `
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="px-4 py-5 sm:px-6 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Aktuelle Nutzung</h3>
                    <button type="button" id="edit-current-usage-btn" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <svg class="-ml-0.5 mr-1 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                        Bearbeiten
                    </button>
                </div>
                <div class="px-4 py-5 sm:p-6">
                    <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
                        <div class="sm:col-span-1">
                            <dt class="text-sm font-medium text-gray-500">Aktueller Fahrer</dt>
                            <dd class="mt-1 text-sm text-gray-900">${driver.firstName} ${driver.lastName}</dd>
                        </div>
                        <div class="sm:col-span-1">
                            <dt class="text-sm font-medium text-gray-500">Abteilung</dt>
                            <dd class="mt-1 text-sm text-gray-900">${department || "Nicht angegeben"}</dd>
                        </div>
                        <div class="sm:col-span-1">
                            <dt class="text-sm font-medium text-gray-500">Nutzung seit</dt>
                            <dd class="mt-1 text-sm text-gray-900">${usageStartDate}</dd>
                        </div>
                        <div class="sm:col-span-1">
                            <dt class="text-sm font-medium text-gray-500">Geplante Rückgabe</dt>
                            <dd class="mt-1 text-sm text-gray-900">${usageEndDate}</dd>
                        </div>
                        <div class="sm:col-span-2">
                            <dt class="text-sm font-medium text-gray-500">Projekt/Zweck</dt>
                            <dd class="mt-1 text-sm text-gray-900">${project || "Nicht angegeben"}</dd>
                        </div>
                    </dl>
                </div>
            </div>
        `;

            // Event-Listener für den "Bearbeiten"-Button
            const editUsageBtn = document.getElementById('edit-current-usage-btn');
            if (editUsageBtn) {
                editUsageBtn.addEventListener('click', () => {
                    const editUsageModal = document.getElementById('edit-usage-modal');
                    if (editUsageModal) {
                        // Formularelemente mit aktuellen Werten füllen
                        if (activeUsage) {
                            const form = document.getElementById('edit-current-usage-form');
                            if (form) {
                                // Select-Feld für Fahrer suchen und den aktuellen Fahrer auswählen
                                const driverSelect = form.querySelector('#current-driver');
                                if (driverSelect) {
                                    // Prüfen, ob der Fahrer in der Liste ist, sonst dynamisch hinzufügen
                                    let driverOption = Array.from(driverSelect.options).find(option => option.value === driver.id);

                                    if (!driverOption) {
                                        driverOption = document.createElement('option');
                                        driverOption.value = driver.id;
                                        driverOption.textContent = `${driver.firstName} ${driver.lastName}`;
                                        driverSelect.appendChild(driverOption);
                                    }

                                    driverSelect.value = driver.id;
                                }

                                // Startdatum und -zeit setzen
                                if (activeUsage.startDate) {
                                    const startDate = new Date(activeUsage.startDate);
                                    const startDateInput = form.querySelector('#current-start-date');
                                    const startTimeInput = form.querySelector('#current-start-time');

                                    if (startDateInput) startDateInput.value = formatDateForInput(startDate);
                                    if (startTimeInput) startTimeInput.value = formatTimeForInput(startDate);
                                }

                                // Enddatum und -zeit setzen
                                if (activeUsage.endDate) {
                                    const endDate = new Date(activeUsage.endDate);
                                    const endDateInput = form.querySelector('#current-end-date');
                                    const endTimeInput = form.querySelector('#current-end-time');

                                    if (endDateInput) endDateInput.value = formatDateForInput(endDate);
                                    if (endTimeInput) endTimeInput.value = formatTimeForInput(endDate);
                                }

                                // Weitere Felder setzen
                                const departmentInput = form.querySelector('#current-department');
                                if (departmentInput && activeUsage.department) {
                                    // Versuche den passenden Wert zu finden oder wähle den ersten aus
                                    const option = Array.from(departmentInput.options).find(opt =>
                                        opt.textContent.toLowerCase() === activeUsage.department.toLowerCase());

                                    if (option) {
                                        departmentInput.value = option.value;
                                    }
                                }

                                const projectInput = form.querySelector('#current-project');
                                if (projectInput) {
                                    projectInput.value = activeUsage.project || activeUsage.purpose || '';
                                }

                                const notesInput = form.querySelector('#current-usage-notes');
                                if (notesInput) {
                                    notesInput.value = activeUsage.notes || '';
                                }

                                // Verstecktes Feld für die Nutzungs-ID hinzufügen
                                let idInput = form.querySelector('input[name="usage-id"]');
                                if (!idInput) {
                                    idInput = document.createElement('input');
                                    idInput.type = 'hidden';
                                    idInput.name = 'usage-id';
                                    form.appendChild(idInput);
                                }
                                idInput.value = activeUsage.id || '';
                            }
                        }

                        editUsageModal.classList.remove('hidden');
                    }
                });
            }
        }

        // Funktion zum Laden und Anzeigen der Wartungseinträge
        function loadMaintenanceEntries() {
            fetch(`/api/maintenance/vehicle/${vehicleId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Wartungseinträge nicht gefunden');
                    return response.json();
                })
                .then(data => {
                    const maintenanceEntries = data.maintenance || [];
                    console.log("Geladene Wartungseinträge:", maintenanceEntries);

                    updateMaintenanceTable(maintenanceEntries);
                })
                .catch(error => {
                    console.error('Fehler beim Laden der Wartungseinträge:', error);
                    updateMaintenanceTable([]);
                });
        }

        // Funktion zum Aktualisieren der Wartungstabelle
        function updateMaintenanceTable(entries) {
            const tableBody = document.getElementById('maintenance-table-body');
            if (!tableBody) return;

            if (!entries || entries.length === 0) {
                tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="py-4 text-center text-gray-500">
                        Keine Wartungseinträge gefunden.
                    </td>
                </tr>
            `;
                return;
            }

            // Einträge nach Datum sortieren (neueste zuerst)
            entries.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Tabelle mit Einträgen füllen
            tableBody.innerHTML = entries.map(entry => {
                const date = formatDate(entry.date);
                let type = 'Sonstiges';

                switch (entry.type) {
                    case 'inspection': type = 'Inspektion'; break;
                    case 'oil-change': type = 'Ölwechsel'; break;
                    case 'tire-change': type = 'Reifenwechsel'; break;
                    case 'repair': type = 'Reparatur'; break;
                }

                return `
                <tr>
                    <td class="py-3.5 pl-4 pr-3 text-left text-sm text-gray-900 sm:pl-0">${date}</td>
                    <td class="px-3 py-3.5 text-left text-sm text-gray-900">${type}</td>
                    <td class="px-3 py-3.5 text-left text-sm text-gray-900">${entry.mileage} km</td>
                    <td class="px-3 py-3.5 text-left text-sm text-gray-900">${entry.cost ? (entry.cost + ' €') : '-'}</td>
                    <td class="relative py-3.5 pl-3 pr-4 sm:pr-0 text-right">
                        <button class="edit-maintenance-btn text-indigo-600 hover:text-indigo-900" data-id="${entry.id}">
                            Bearbeiten
                        </button>
                    </td>
                </tr>
            `;
            }).join('');

            // Event-Listener für die Bearbeiten-Buttons
            const editButtons = tableBody.querySelectorAll('.edit-maintenance-btn');
            editButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const entryId = this.getAttribute('data-id');
                    openMaintenanceModal(true, entryId);
                });
            });
        }

        // Funktion zum Laden und Anzeigen der Nutzungshistorie
        function loadUsageHistory() {
            fetch(`/api/usage/vehicle/${vehicleId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Nutzungshistorie nicht gefunden');
                    return response.json();
                })
                .then(data => {
                    const usageEntries = data.usage || [];
                    console.log("Geladene Nutzungseinträge:", usageEntries);

                    updateUsageTable(usageEntries);
                })
                .catch(error => {
                    console.error('Fehler beim Laden der Nutzungshistorie:', error);
                    updateUsageTable([]);
                });
        }

        // Funktion zum Aktualisieren der Nutzungstabelle
        function updateUsageTable(entries) {
            const tableBody = document.getElementById('usage-table-body');
            if (!tableBody) return;

            if (!entries || entries.length === 0) {
                tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="py-4 text-center text-gray-500">
                        Keine Nutzungseinträge gefunden.
                    </td>
                </tr>
            `;
                return;
            }

            // Einträge nach Startdatum sortieren (neueste zuerst)
            entries.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

            // Tabelle mit Einträgen füllen
            tableBody.innerHTML = entries.map(entry => {
                const startDate = formatDate(entry.startDate);
                const endDate = entry.endDate ? formatDate(entry.endDate) : '-';
                const timeframe = `${startDate} - ${endDate}`;

                // Kilometerstand-Differenz berechnen
                let mileageInfo = `${entry.startMileage} km`;
                if (entry.endMileage && entry.endMileage > entry.startMileage) {
                    const diff = entry.endMileage - entry.startMileage;
                    mileageInfo = `${entry.startMileage} - ${entry.endMileage} km (+${diff} km)`;
                }

                return `
                <tr>
                    <td class="py-3.5 pl-4 pr-3 text-left text-sm text-gray-900 sm:pl-6">${timeframe}</td>
                    <td class="px-3 py-3.5 text-left text-sm text-gray-900">${entry.driverName || '-'}</td>
                    <td class="px-3 py-3.5 text-left text-sm text-gray-900">${entry.project || entry.purpose || '-'}</td>
                    <td class="px-3 py-3.5 text-left text-sm text-gray-900">${mileageInfo}</td>
                    <td class="relative py-3.5 pl-3 pr-4 sm:pr-6 text-right">
                        <button class="edit-usage-btn text-indigo-600 hover:text-indigo-900" data-id="${entry.id}">
                            Bearbeiten
                        </button>
                    </td>
                </tr>
            `;
            }).join('');

            // Event-Listener für die Bearbeiten-Buttons
            const editButtons = tableBody.querySelectorAll('.edit-usage-btn');
            editButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const entryId = this.getAttribute('data-id');
                    openUsageModal(true, entryId);
                });
            });
        }

        // Funktion zum Erstellen der Charts für die Statistikseite
        function createCharts() {
            // Charts nur erstellen, wenn der Tab existiert
            if (!document.getElementById('statistics')) return;

            // Beispieldaten für die Charts (sollten in der Produktion aus der API kommen)
            const costData = [
                { month: 'Apr', year: '2024', cost: 380 },
                { month: 'Mai', year: '2024', cost: 420 },
                { month: 'Jun', year: '2024', cost: 350 },
                { month: 'Jul', year: '2024', cost: 500 },
                { month: 'Aug', year: '2024', cost: 420 },
                { month: 'Sep', year: '2024', cost: 380 },
                { month: 'Okt', year: '2024', cost: 450 },
                { month: 'Nov', year: '2024', cost: 380 },
                { month: 'Dez', year: '2024', cost: 520 },
                { month: 'Jan', year: '2025', cost: 450 },
                { month: 'Feb', year: '2025', cost: 380 },
                { month: 'Mär', year: '2025', cost: 400 }
            ];

            const driverData = [
                { driver: 'Max Mustermann', usage: 42 },
                { driver: 'Erika Musterfrau', usage: 28 },
                { driver: 'John Doe', usage: 18 },
                { driver: 'Andere', usage: 12 }
            ];

            const projectData = [
                { project: 'Digital Transformation', usage: 35 },
                { project: 'Vertriebsbesuche', usage: 25 },
                { project: 'Schulungen', usage: 20 },
                { project: 'Andere', usage: 20 }
            ];

            // Kostenchart erstellen
            createCostChart(costData);

            // Fahrer-Pie-Chart erstellen
            createDriverPieChart(driverData);

            // Projekt-Pie-Chart erstellen
            createProjectPieChart(projectData);

            // Kennzahlen aktualisieren
            updateStatisticsSummary(costData, driverData);
        }

        // Funktion zum Erstellen des Kostendiagramms
        function createCostChart(data) {
            const chartElement = document.getElementById('costChart');
            if (!chartElement) return;

            const options = {
                chart: {
                    height: 350,
                    type: 'bar',
                    toolbar: {
                        show: false
                    }
                },
                colors: ['#3b82f6'],
                plotOptions: {
                    bar: {
                        columnWidth: '55%',
                        borderRadius: 4
                    }
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    show: true,
                    width: 2,
                    colors: ['transparent']
                },
                xaxis: {
                    categories: data.map(item => `${item.month} ${item.year}`),
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    }
                },
                yaxis: {
                    title: {
                        text: 'Kosten (€)'
                    }
                },
                fill: {
                    opacity: 1
                },
                tooltip: {
                    y: {
                        formatter: function(val) {
                            return val + " €";
                        }
                    }
                }
            };

            const series = [{
                name: 'Kosten',
                data: data.map(item => item.cost)
            }];

            const chart = new ApexCharts(chartElement, {
                ...options,
                series: series
            });

            chart.render();
        }

        // Funktion zum Erstellen des Fahrer-Pie-Charts
        function createDriverPieChart(data) {
            const chartElement = document.getElementById('driverPieChart');
            if (!chartElement) return;

            const options = {
                chart: {
                    type: 'pie',
                    height: 320,
                    toolbar: {
                        show: false
                    }
                },
                colors: ['#3b82f6', '#ef4444', '#f59e0b', '#10b981'],
                labels: data.map(item => item.driver),
                series: data.map(item => item.usage),
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    y: {
                        formatter: function(val) {
                            return val + "%";
                        }
                    }
                }
            };

            const chart = new ApexCharts(chartElement, options);
            chart.render();
        }

        // Funktion zum Erstellen des Projekt-Pie-Charts
        function createProjectPieChart(data) {
            const chartElement = document.getElementById('projectPieChart');
            if (!chartElement) return;

            const options = {
                chart: {
                    type: 'pie',
                    height: 320,
                    toolbar: {
                        show: false
                    }
                },
                colors: ['#3b82f6', '#ef4444', '#f59e0b', '#10b981'],
                labels: data.map(item => item.project),
                series: data.map(item => item.usage),
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    y: {
                        formatter: function(val) {
                            return val + "%";
                        }
                    }
                }
            };

            const chart = new ApexCharts(chartElement, options);
            chart.render();
        }

        // Funktion zum Aktualisieren der Statistikzusammenfassung
        function updateStatisticsSummary(costData, driverData) {
            // Gesamtkosten berechnen
            const totalCost = costData.reduce((sum, item) => sum + item.cost, 0);

            // Weitere Statistiken könnten aus API-Daten kommen
            const totalKilometers = 12500;
            const costPerKm = totalCost / totalKilometers;
            const utilization = 65; // Prozent

            // UI aktualisieren
            setElementText('total-kilometers', `${totalKilometers.toLocaleString()} km`);
            setElementText('cost-per-km', `${costPerKm.toFixed(2)} € / km`);
            setElementText('total-cost', `${totalCost.toLocaleString()} €`);
            setElementText('utilization', `${utilization}%`);
        }

        // === Modal-Funktionen ===

        // Funktion zum Einrichten der Wartungsmodals
        function setupMaintenanceModals() {
            // "Wartung hinzufügen"-Button
            const addMaintenanceBtn = document.getElementById('add-maintenance-btn');
            if (addMaintenanceBtn) {
                addMaintenanceBtn.addEventListener('click', () => openMaintenanceModal(false));
            }

            // Schließen-Buttons für Wartungsmodal
            const closeModalBtns = document.querySelectorAll('.close-modal-btn');
            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', closeMaintenanceModal);
            });

            // Wartungsformular abschicken
            const maintenanceForm = document.getElementById('maintenance-form');
            if (maintenanceForm) {
                maintenanceForm.addEventListener('submit', handleMaintenanceSubmit);
            }
        }

        // Funktion zum Einrichten der Nutzungsmodals
        function setupUsageModals() {
            // "Nutzung hinzufügen"-Button
            const addUsageBtn = document.getElementById('add-usage-btn');
            if (addUsageBtn) {
                addUsageBtn.addEventListener('click', () => openUsageModal(false));
            }

            // Schließen-Buttons für Nutzungsmodal
            const closeModalBtns = document.querySelectorAll('.close-modal-btn');
            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', closeUsageModal);
            });

            // Schließen-Button für aktuelle Nutzung Modal
            const closeCurrentUsageModalBtns = document.querySelectorAll('.close-current-usage-modal-btn');
            closeCurrentUsageModalBtns.forEach(btn => {
                btn.addEventListener('click', closeCurrentUsageModal);
            });

            // Nutzungsformular abschicken
            const usageForm = document.getElementById('usage-form');
            if (usageForm) {
                usageForm.addEventListener('submit', handleUsageSubmit);
            }

            // Formular für aktuelle Nutzung abschicken
            const currentUsageForm = document.getElementById('edit-current-usage-form');
            if (currentUsageForm) {
                currentUsageForm.addEventListener('submit', handleCurrentUsageSubmit);
            }
        }

        // Funktion zum Einrichten des Fahrzeug-Bearbeiten-Modals
        function setupVehicleEditModal() {
            // "Fahrzeug bearbeiten"-Button
            const editVehicleBtn = document.getElementById('edit-vehicle-btn');
            if (editVehicleBtn) {
                editVehicleBtn.addEventListener('click', () => {
                    const editVehicleModal = document.getElementById('edit-vehicle-modal');
                    if (editVehicleModal) {
                        editVehicleModal.classList.remove('hidden');
                    }
                });
            }

            // Schließen-Button für Fahrzeug-Modal
            const closeEditModalBtns = document.querySelectorAll('.close-edit-modal-btn');
            closeEditModalBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const editVehicleModal = document.getElementById('edit-vehicle-modal');
                    if (editVehicleModal) {
                        editVehicleModal.classList.add('hidden');
                    }
                });
            });

            // Fahrzeugformular abschicken
            const editVehicleForm = document.getElementById('edit-vehicle-form');
            if (editVehicleForm) {
                editVehicleForm.addEventListener('submit', handleVehicleEditSubmit);
            }
        }

        // Funktion zum Öffnen des Wartungsmodals
        function openMaintenanceModal(isEdit = false, maintenanceId = null) {
            const modal = document.getElementById('maintenance-modal');
            const modalTitle = document.getElementById('maintenance-modal-title');
            const form = document.getElementById('maintenance-form');

            if (!modal || !modalTitle || !form) return;

            // Formulardaten zurücksetzen
            form.reset();

            if (isEdit && maintenanceId) {
                modalTitle.textContent = 'Wartung/Inspektion bearbeiten';

                // Wartungseintrag von der API laden
                fetch(`/api/maintenance/${maintenanceId}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Wartungseintrag nicht gefunden');
                        return response.json();
                    })
                    .then(data => {
                        const maintenance = data.maintenance;

                        // Formularfelder ausfüllen
                        if (maintenance.date) {
                            document.getElementById('maintenance-date').value = formatDateForInput(maintenance.date);
                        }

                        document.getElementById('maintenance-type').value = maintenance.type;
                        document.getElementById('mileage').value = maintenance.mileage || '';
                        document.getElementById('cost').value = maintenance.cost || '';
                        document.getElementById('workshop').value = maintenance.workshop || '';
                        document.getElementById('maintenance-notes').value = maintenance.notes || '';

                        // Verstecktes Feld für die Wartungs-ID hinzufügen
                        let idInput = form.querySelector('input[name="maintenance-id"]');
                        if (!idInput) {
                            idInput = document.createElement('input');
                            idInput.type = 'hidden';
                            idInput.name = 'maintenance-id';
                            form.appendChild(idInput);
                        }
                        idInput.value = maintenanceId;
                    })
                    .catch(error => {
                        console.error('Fehler beim Laden des Wartungseintrags:', error);
                        closeMaintenanceModal();
                        showNotification('Fehler beim Laden des Wartungseintrags', 'error');
                    });
            } else {
                modalTitle.textContent = 'Wartung/Inspektion hinzufügen';

                // Aktuelles Datum vorausfüllen
                const today = new Date();
                document.getElementById('maintenance-date').value = formatDateForInput(today);

                // Das Versteckte ID-Feld entfernen, falls vorhanden
                const idInput = form.querySelector('input[name="maintenance-id"]');
                if (idInput) idInput.remove();
            }

            modal.classList.remove('hidden');
        }

        // Funktion zum Schließen des Wartungsmodals
        function closeMaintenanceModal() {
            const modal = document.getElementById('maintenance-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // Funktion zum Öffnen des Nutzungsmodals
        function openUsageModal(isEdit = false, usageId = null) {
            const modal = document.getElementById('usage-modal');
            const modalTitle = document.getElementById('usage-modal-title');
            const form = document.getElementById('usage-form');

            if (!modal || !modalTitle || !form) return;

            // Formulardaten zurücksetzen
            form.reset();

            // Fahrer für die Auswahl laden
            loadDriversForUsageForm();

            if (isEdit && usageId) {
                modalTitle.textContent = 'Nutzung bearbeiten';

                // Nutzungseintrag von der API laden
                fetch(`/api/usage/${usageId}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Nutzungseintrag nicht gefunden');
                        return response.json();
                    })
                    .then(data => {
                        const usage = data.usage;

                        // Startdatum und -zeit ausfüllen
                        if (usage.startDate) {
                            const startDate = new Date(usage.startDate);
                            document.getElementById('start-date').value = formatDateForInput(startDate);
                            document.getElementById('start-time').value = formatTimeForInput(startDate);
                        }

                        // Enddatum und -zeit ausfüllen, falls vorhanden
                        if (usage.endDate) {
                            const endDate = new Date(usage.endDate);
                            document.getElementById('end-date').value = formatDateForInput(endDate);
                            document.getElementById('end-time').value = formatTimeForInput(endDate);
                        }

                        // Fahrer auswählen
                        if (usage.driverId) {
                            const driverSelect = document.getElementById('driver');
                            if (driverSelect) {
                                // Warten, bis die Fahrer geladen sind
                                const waitForDriverOptions = setInterval(() => {
                                    if (driverSelect.options.length > 1) {
                                        clearInterval(waitForDriverOptions);

                                        // Prüfen, ob der Fahrer in der Liste ist
                                        let driverOption = Array.from(driverSelect.options).find(option =>
                                            option.value === usage.driverId);

                                        if (!driverOption && data.driver) {
                                            // Fahrer zur Liste hinzufügen
                                            driverOption = document.createElement('option');
                                            driverOption.value = usage.driverId;
                                            driverOption.textContent = `${data.driver.firstName} ${data.driver.lastName}`;
                                            driverSelect.appendChild(driverOption);
                                        }

                                        if (driverOption) {
                                            driverSelect.value = usage.driverId;
                                        }
                                    }
                                }, 100);
                            }
                        }

                        // Weitere Felder ausfüllen
                        document.getElementById('project').value = usage.project || usage.purpose || '';
                        document.getElementById('start-mileage').value = usage.startMileage || '';
                        document.getElementById('end-mileage').value = usage.endMileage || '';
                        document.getElementById('usage-notes').value = usage.notes || '';

                        // Verstecktes Feld für die Nutzungs-ID hinzufügen
                        let idInput = form.querySelector('input[name="usage-id"]');
                        if (!idInput) {
                            idInput = document.createElement('input');
                            idInput.type = 'hidden';
                            idInput.name = 'usage-id';
                            form.appendChild(idInput);
                        }
                        idInput.value = usageId;
                    })
                    .catch(error => {
                        console.error('Fehler beim Laden des Nutzungseintrags:', error);
                        closeUsageModal();
                        showNotification('Fehler beim Laden des Nutzungseintrags', 'error');
                    });
            } else {
                modalTitle.textContent = 'Nutzung eintragen';

                // Aktuelles Datum und Uhrzeit vorausfüllen
                const now = new Date();
                document.getElementById('start-date').value = formatDateForInput(now);
                document.getElementById('start-time').value = formatTimeForInput(now);

                // Aktuellen Kilometerstand abfragen und vorausfüllen
                fetch(`/api/vehicles/${vehicleId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.vehicle && data.vehicle.mileage) {
                            document.getElementById('start-mileage').value = data.vehicle.mileage;
                        }
                    })
                    .catch(error => console.error('Fehler beim Laden des Kilometerstands:', error));

                // Das Versteckte ID-Feld entfernen, falls vorhanden
                const idInput = form.querySelector('input[name="usage-id"]');
                if (idInput) idInput.remove();
            }

            modal.classList.remove('hidden');
        }

        // Funktion zum Schließen des Nutzungsmodals
        function closeUsageModal() {
            const modal = document.getElementById('usage-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // Funktion zum Schließen des Modals für aktuelle Nutzung
        function closeCurrentUsageModal() {
            const modal = document.getElementById('edit-usage-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // Funktion zum Laden der Fahrer für das Nutzungsformular
        function loadDriversForUsageForm() {
            const driverSelect = document.getElementById('driver');
            if (!driverSelect) return;

            // Bestehende Optionen behalten, aber den Rest zurücksetzen
            const firstOption = driverSelect.querySelector('option:first-child');
            driverSelect.innerHTML = '';

            if (firstOption) {
                driverSelect.appendChild(firstOption);
            } else {
                const noDriverOption = document.createElement('option');
                noDriverOption.value = '';
                noDriverOption.textContent = 'Fahrer auswählen';
                driverSelect.appendChild(noDriverOption);
            }

            // Fahrer von der API laden
            fetch('/api/drivers')
                .then(response => {
                    if (!response.ok) throw new Error('Fehler beim Laden der Fahrer');
                    return response.json();
                })
                .then(data => {
                    const drivers = data.drivers || [];

                    // Fahrer zur Select-Liste hinzufügen
                    drivers.forEach(driver => {
                        const option = document.createElement('option');
                        option.value = driver.id;
                        option.textContent = `${driver.firstName} ${driver.lastName}`;
                        driverSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Fehler beim Laden der Fahrer:', error);
                });
        }

        // Funktion zur Verarbeitung des Wartungsformulars
        function handleMaintenanceSubmit(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const maintenanceData = {};

            // Formulardaten in ein Objekt umwandeln
            for (let [key, value] of formData.entries()) {
                maintenanceData[key] = value;
            }

            // Prüfen, ob es eine Bearbeitung ist
            const maintenanceId = maintenanceData['maintenance-id'];
            const isEdit = !!maintenanceId;

            // API-Anfrage vorbereiten
            const apiUrl = isEdit ?
                `/api/maintenance/${maintenanceId}` :
                '/api/maintenance';

            const method = isEdit ? 'PUT' : 'POST';

            // Daten in das von der API erwartete Format umwandeln
            const apiData = {
                vehicleId: vehicleId,
                date: maintenanceData['maintenance-date'],
                type: maintenanceData['maintenance-type'],
                mileage: parseInt(maintenanceData.mileage) || 0,
                cost: parseFloat(maintenanceData.cost) || 0,
                workshop: maintenanceData.workshop,
                notes: maintenanceData['maintenance-notes']
            };

            // API-Anfrage senden
            fetch(apiUrl, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(apiData)
            })
                .then(response => {
                    if (!response.ok) throw new Error('Fehler beim Speichern des Wartungseintrags');
                    return response.json();
                })
                .then(data => {
                    closeMaintenanceModal();
                    loadMaintenanceEntries(); // Wartungsliste aktualisieren
                    showNotification(
                        isEdit ? 'Wartungseintrag erfolgreich aktualisiert' :
                            'Wartungseintrag erfolgreich erstellt',
                        'success'
                    );
                })
                .catch(error => {
                    console.error('Fehler:', error);
                    showNotification('Fehler beim Speichern: ' + error.message, 'error');
                });
        }

        // Funktion zur Verarbeitung des Nutzungsformulars
        function handleUsageSubmit(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const usageData = {};

            // Formulardaten in ein Objekt umwandeln
            for (let [key, value] of formData.entries()) {
                usageData[key] = value;
            }

            // Prüfen, ob es eine Bearbeitung ist
            const usageId = usageData['usage-id'];
            const isEdit = !!usageId;

            // API-Anfrage vorbereiten
            const apiUrl = isEdit ?
                `/api/usage/${usageId}` :
                '/api/usage';

            const method = isEdit ? 'PUT' : 'POST';

            // Prüfen, ob ein Fahrer ausgewählt wurde
            if (!usageData.driver) {
                showNotification('Bitte wählen Sie einen Fahrer aus', 'error');
                return;
            }

            // Daten in das von der API erwartete Format umwandeln
            const apiData = {
                vehicleId: vehicleId,
                driverId: usageData.driver,
                startDate: usageData['start-date'],
                startTime: usageData['start-time'],
                endDate: usageData['end-date'] || null,
                endTime: usageData['end-time'] || null,
                startMileage: parseInt(usageData['start-mileage']) || 0,
                endMileage: parseInt(usageData['end-mileage']) || 0,
                project: usageData.project,
                status: (usageData['end-date'] && usageData['end-time']) ? 'completed' : 'active',
                notes: usageData['usage-notes']
            };

            // API-Anfrage senden
            fetch(apiUrl, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(apiData)
            })
                .then(response => {
                    if (!response.ok) throw new Error('Fehler beim Speichern des Nutzungseintrags');
                    return response.json();
                })
                .then(data => {
                    closeUsageModal();
                    loadVehicleData(); // Fahrzeugdaten komplett neu laden
                    showNotification(
                        isEdit ? 'Nutzungseintrag erfolgreich aktualisiert' :
                            'Nutzungseintrag erfolgreich erstellt',
                        'success'
                    );
                })
                .catch(error => {
                    console.error('Fehler:', error);
                    showNotification('Fehler beim Speichern: ' + error.message, 'error');
                });
        }

        // Funktion zur Verarbeitung des Formulars für die aktuelle Nutzung
        function handleCurrentUsageSubmit(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const usageData = {};

            // Formulardaten in ein Objekt umwandeln
            for (let [key, value] of formData.entries()) {
                usageData[key] = value;
            }

            // API-Anfrage vorbereiten
            const usageId = usageData['usage-id'];
            if (!usageId) {
                showNotification('Fehler: Keine Nutzungs-ID gefunden', 'error');
                return;
            }

            // Daten in das von der API erwartete Format umwandeln
            const apiData = {
                vehicleId: vehicleId,
                driverId: usageData['current-driver'],
                startDate: usageData['current-start-date'],
                startTime: usageData['current-start-time'],
                endDate: usageData['current-end-date'] || null,
                endTime: usageData['current-end-time'] || null,
                project: usageData['current-project'],
                department: usageData['current-department'] || '',
                status: usageData['usage-status'] || 'active',
                notes: usageData['current-usage-notes']
            };

            // API-Anfrage senden
            fetch(`/api/usage/${usageId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(apiData)
            })
                .then(response => {
                    if (!response.ok) throw new Error('Fehler beim Aktualisieren der aktuellen Nutzung');
                    return response.json();
                })
                .then(data => {
                    closeCurrentUsageModal();
                    loadVehicleData(); // Fahrzeugdaten komplett neu laden
                    showNotification('Aktuelle Nutzung erfolgreich aktualisiert', 'success');
                })
                .catch(error => {
                    console.error('Fehler:', error);
                    showNotification('Fehler beim Speichern: ' + error.message, 'error');
                });
        }

        // Funktion zur Verarbeitung des Fahrzeug-Bearbeiten-Formulars
        function handleVehicleEditSubmit(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const vehicleData = {};

            // Formulardaten in ein Objekt umwandeln
            for (let [key, value] of formData.entries()) {
                vehicleData[key] = value;
            }

            // Marke und Modell aufteilen
            let brand = "";
            let model = "";

            if (vehicleData.model) {
                const brandModelParts = vehicleData.model.split(' ');
                if (brandModelParts.length > 1) {
                    brand = brandModelParts[0];
                    model = brandModelParts.slice(1).join(' ');
                } else {
                    brand = vehicleData.model;
                }
            }

            // Daten in das von der API erwartete Format umwandeln
            const apiData = {
                licensePlate: vehicleData.license_plate,
                brand: brand,
                model: model,
                year: parseInt(vehicleData.year) || 0,
                color: vehicleData.color,
                // VehicleID wird nicht aktualisiert
                vin: vehicleData.vin,
                fuelType: vehicleData.fuel_type,
                mileage: parseInt(vehicleData.current_mileage) || 0,
                registrationDate: vehicleData.registration_date || null,
                nextInspectionDate: vehicleData.next_inspection || null,
                insuranceCompany: vehicleData.insurance,
                insuranceNumber: vehicleData.insurance_number,
                insuranceType: vehicleData.insurance_type,
                notes: vehicleData.vehicle_notes
            };

            // API-Anfrage senden
            fetch(`/api/vehicles/${vehicleId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(apiData)
            })
                .then(response => {
                    if (!response.ok) throw new Error('Fehler beim Aktualisieren des Fahrzeugs');
                    return response.json();
                })
                .then(data => {
                    const editVehicleModal = document.getElementById('edit-vehicle-modal');
                    if (editVehicleModal) {
                        editVehicleModal.classList.add('hidden');
                    }

                    loadVehicleData(); // Fahrzeugdaten komplett neu laden
                    showNotification('Fahrzeug erfolgreich aktualisiert', 'success');
                })
                .catch(error => {
                    console.error('Fehler:', error);
                    showNotification('Fehler beim Speichern: ' + error.message, 'error');
                });
        }

        // === Hilfsfunktionen ===

        // Funktion zum Formatieren von Datumsangaben
        function formatDate(dateString) {
            if (!dateString) return '-';

            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '-';

            return date.toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Funktion zum Formatieren von Datums- und Zeitangaben
        function formatDateTime(dateString) {
            if (!dateString) return '-';

            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '-';

            return date.toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            }) + ', ' + date.toLocaleTimeString('de-DE', {
                hour: '2-digit',
                minute: '2-digit'
            }) + ' Uhr';
        }

        // Funktion zum Formatieren eines Datums für Input-Felder
        function formatDateForInput(dateString) {
            if (!dateString) return '';

            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '';

            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');

            return `${year}-${month}-${day}`;
        }

        // Funktion zum Formatieren einer Zeit für Input-Felder
        function formatTimeForInput(dateString) {
            if (!dateString) return '';

            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '';

            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');

            return `${hours}:${minutes}`;
        }

        // Funktion zum Setzen von Text in einem Element
        function setElementText(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            }
        }

        // Funktion zum Anzeigen von Benachrichtigungen (kann je nach UI-Framework angepasst werden)
        function showNotification(message, type = 'info') {
            // Hier könnte eine UI-Benachrichtigungsfunktion eingebunden werden
            console.log(`Benachrichtigung (${type}):`, message);

            // Einfache Alert-Nachricht, in der Produktion durch ein besseres UI-Element ersetzen
            if (type === 'error') {
                alert('Fehler: ' + message);
            } else if (type === 'success') {
                alert('Erfolg: ' + message);
            }
        }
    });
</script>
</body>
</html>
{{ end }}